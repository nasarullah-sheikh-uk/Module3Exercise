---
- name: Install To Do App on new webserver
  hosts: managed_hosts
  remote_user: ec2-user

  tasks: 
  - name: Install git on VM
    ansible.builtin.yum:
      name: git
      state: present
    become: yes

  - name: Install Python on VM
    ansible.builtin.yum:
      name: python
      state: latest
    become: yes

  - name: Check Poerty on VM
    ansible.builtin.shell:
      cmd: PATH=$PATH:/etc/poetry/bin; which poetry
    register: poetry_exists
    failed_when: no
    changed_when: no

  - name: Install Poetry on VM
    ansible.builtin.shell:
      cmd: curl -sSL https://install.python-poetry.org | POETRY_HOME=/etc/poetry python3 -
    when: poetry_exists.rc != 0
    become: yes    
 
  - name: Create base directory for To Do App
    ansible.builtin.file: 
      path: /opt/todoapp 
      state: directory 
      owner: ec2-user 
      mode: 0774
    become: yes